<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soundbites Admin</title>
    <meta name="description" content="Admin panel for managing the Soundbites hearing quiz and viewing analytics">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='16' fill='%23C92A76'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
    <script src="../../Main app/header-sizer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="admin-auth-backend.js"></script>
</head>
<body>
    <a href="#main" class="skip-link">Skip to content</a>
    <div class="container" role="application">
        <header>
            <div class="logo-container">
                <img src="../../Main app/soundbites_logo_magenta.webp" alt="Soundbites Logo" class="brand-logo" />
                <span class="play-button-accent" aria-hidden="true"></span>
            </div>
            <p class="sb-copy">Discover if Soundbites can improve your hearing experience</p>
            <div class="wave-decoration">
                <img src="../../Main app/dot_wave_2.webp" alt="Sound Wave" class="wave-graphic">
            </div>
            <nav class="admin-nav">
                <button id="questions-tab" class="tab-btn" type="button" onclick="console.log('Questions clicked'); if(window.admin){window.admin.switchTab('questions')}else{console.error('window.admin not found')}">Questions</button>
                <button id="analytics-tab" class="tab-btn active" type="button" onclick="console.log('Analytics clicked'); if(window.admin){window.admin.switchTab('analytics')}else{console.error('window.admin not found')}">Analytics & Data</button>
                <span style="flex:1"></span>
                <button id="logout-btn" class="btn btn-danger" type="button">Log out</button>
            </nav>
        </header>

        <main id="main" role="main">
        <!-- Questions Panel (top-level sibling of Analytics) -->
        <section id="questions-panel" class="admin-panel" style="display:none;">
            <h2>Manage Questions</h2>
            <form id="question-form">
                <div class="form-group">
                    <label for="question-text">Question Text</label>
                    <input id="question-text" type="text" placeholder="Enter your question" required />
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="question-type">Type</label>
                        <select id="question-type">
                            <option value="slider">Slider (1-10)</option>
                            <option value="hours-slider">Hours per day (1-24)</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="yes-no">Yes / No</option>
                            <option value="text">Open Text</option>
                        </select>
                    </div>
                    <div class="form-col"></div>
                </div>
                <div id="type-specific-options"></div>
                <button type="submit" class="btn btn-primary">Add Question</button>
            </form>
            <h3 style="margin-top:1rem;">Question List</h3>
            <div id="questions-list"></div>
        </section>

        <div id="analytics-panel" class="admin-panel" style="display: block;">
            <h2>Analytics & Data Export</h2>

            <!-- Quick stats -->
            <section class="stats-overview">
                <div class="stat-card"><h3>Total Responses</h3><span id="total-responses">0</span></div>
                <div class="stat-card"><h3>Conversion Rate</h3><span id="conversion-rate">0%</span></div>
                <div class="stat-card"><h3>Average Score</h3><span id="average-score">0</span></div>
            </section>

            <!-- Filters -->
            <section class="filters-section" style="margin: 0.5rem 0 1.25rem 0;">
                <h3>Filters</h3>
                <div class="form-row">
                    <div class="form-col">
                        <label for="filter-from">From date</label>
                        <input type="date" id="filter-from" />
                    </div>
                    <div class="form-col">
                        <label for="filter-to">To date</label>
                        <input type="date" id="filter-to" />
                    </div>
                    <div class="form-col">
                        <label for="filter-min-score">Min score</label>
                        <input type="number" id="filter-min-score" min="0" max="100" placeholder="0" />
                    </div>
                    <div class="form-col">
                        <label for="filter-max-score">Max score</label>
                        <input type="number" id="filter-max-score" min="0" max="100" placeholder="100" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="filter-source">UTM Source</label>
                        <select id="filter-source"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-medium">UTM Medium</label>
                        <select id="filter-medium"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-campaign">UTM Campaign</label>
                        <select id="filter-campaign"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-reco">Recommendation</label>
                        <select id="filter-reco">
                            <option value="">All</option>
                            <option value="high-need">High Need</option>
                            <option value="moderate-need">Moderate Need</option>
                            <option value="low-need">Low Need</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col" style="display:flex; gap:.5rem; align-items:center;">
                        <button id="preset-7d" class="btn btn-secondary" type="button">Last 7 days</button>
                        <button id="preset-30d" class="btn btn-secondary" type="button">Last 30 days</button>
                        <button id="preset-all" class="btn btn-secondary" type="button">All time</button>
                        <span style="flex:1"></span>
                    </div>
                </div>
            </section>

            <!-- Charts -->
            <section class="charts-section">
                <div class="chart-container"><canvas id="response-chart"></canvas></div>
                <div class="chart-container"><canvas id="hearing-issues-chart"></canvas></div>
                <div class="chart-container"><canvas id="score-histogram"></canvas></div>
                <div class="chart-container"><canvas id="utm-score-chart"></canvas></div>
                <div class="chart-container"><canvas id="question-averages-chart"></canvas></div>
                <div class="chart-container"><canvas id="utm-campaign-score-chart"></canvas></div>
            </section>

            <!-- Export / housekeeping -->
            <section class="export-section">
                <h3>Export & Housekeeping</h3>
                <div class="form-row">
                    <div class="form-col" style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
                        <button id="export-csv" class="btn btn-secondary" type="button">Export CSV</button>
                        <button id="export-json" class="btn btn-secondary" type="button">Export JSON</button>
                        <button id="clear-data" class="btn btn-danger" type="button">Clear All Data</button>
                        <span style="flex:1"></span>
                        <input type="email" id="company-email" placeholder="Email to receive leads" style="max-width:320px;" />
                    </div>
                </div>
            </section>

            <!-- Optional: Results Box Customization (saved to quiz-settings) -->
            <section>
                <h3>Results Box Customization</h3>
                <p class="sb-copy" style="margin:.25rem 0 .6rem;opacity:.9">Optional: Override the final results box text and accent color.</p>
                <form id="quiz-settings">
                    <div class="form-group">
                        <label for="result-title">Result Title</label>
                        <input type="text" id="result-title" placeholder="e.g., Soundbites Highly Recommended" />
                    </div>
                    <div class="form-group">
                        <label for="result-message">Result Message</label>
                        <textarea id="result-message" placeholder="Short explanation shown under the title"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="result-cta">CTA Text</label>
                            <input type="text" id="result-cta" placeholder="e.g., Visit soundbites.com" />
                        </div>
                        <div class="form-col">
                            <label for="result-cta-url">CTA URL</label>
                            <input type="url" id="result-cta-url" placeholder="https://soundbites.com" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="result-color">Accent Color</label>
                        <input type="color" id="result-color" value="#C92A76" style="width:60px;height:36px;padding:0;border:1px solid #ddd;border-radius:6px;" />
                    </div>
                    <button type="submit" class="btn btn-primary">Save Quiz Settings</button>
                </form>
            </section>

            <hr style="margin:1.25rem 0; border:none; border-top:1px solid #e0e0e0;" />
            <section>
                <h3>Account Recovery</h3>
                <p class="sb-copy" style="margin:.25rem 0 .6rem;opacity:.9">Generate a one-time recovery code to reset your username and password if you forget them. Save it somewhere safe.</p>
                <button id="generate-recovery" type="button" class="btn btn-secondary">Generate New Recovery Code</button>
            </section>
        </div>
        </main>
    </div>

    <script src="../../Main app/api-client.js"></script>
    <script src="admin.js"></script>
    <script>
        // Invoke auth gate after DOM is ready so login view replaces body safely when not authed
        document.addEventListener('DOMContentLoaded', function(){
            if (window.initHeaderSizer) window.initHeaderSizer();
            if (window.enforceAuth && !window.enforceAuth()) return;
            if (window.sbIsAuthed && window.sbIsAuthed()) {
                if (!window.admin && typeof QuizAdmin === 'function') { window.admin = new QuizAdmin(); }
            }
        }, { once: true });
    </script>
  </body>
</html>