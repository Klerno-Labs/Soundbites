<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Soundbites Admin</title>
    <meta name="description" content="Admin panel for managing the Soundbites hearing quiz and viewing analytics">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='16' fill='%23C92A76'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/admin/admin.css?v=20251020-1740">
    <script src="/app/config.js"></script>
    <script src="/app/header-sizer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/admin/admin-auth-backend.js"></script>
</head>
<body>
    <a href="#main" class="skip-link">Skip to content</a>
    <div class="container" role="application">
        <header>
            <div class="logo-container">
                <img src="/app/soundbites_logo_magenta.webp" alt="Soundbites Logo" class="brand-logo" />
                <span class="play-button-accent" aria-hidden="true"></span>
            </div>
            <p class="sb-copy">Discover if Soundbites can improve your hearing experience</p>
            <div class="wave-decoration">
                <img src="/app/dot_wave_2.webp" alt="Sound Wave" class="wave-graphic">
            </div>
            <nav class="admin-nav">
                <button id="questions-tab" class="tab-btn" type="button" onclick="console.log('Questions clicked'); if(window.admin){window.admin.switchTab('questions')}else{console.error('window.admin not found')}">Questions</button>
                <button id="analytics-tab" class="tab-btn active" type="button" onclick="console.log('Analytics clicked'); if(window.admin){window.admin.switchTab('analytics')}else{console.error('window.admin not found')}">Analytics</button>
                <button id="marketing-tab" class="tab-btn" type="button" onclick="console.log('Marketing clicked'); if(window.admin){window.admin.switchTab('marketing')}else{console.error('window.admin not found')}">Marketing</button>
                <button id="otis-tab" class="tab-btn" type="button" onclick="console.log('OTIS clicked'); if(window.admin){window.admin.switchTab('otis')}else{console.error('window.admin not found')}">OTIS</button>
                <span style="flex:1"></span>
                <button id="logout-btn" class="btn btn-danger" type="button">Log out</button>
            </nav>
        </header>

        <main id="main" role="main">
        <!-- Questions Panel (top-level sibling of Analytics) -->
        <section id="questions-panel" class="admin-panel" style="display:none;">
            <h2>Manage Questions</h2>
            <form id="question-form">
                <div class="form-group">
                    <label for="question-text">Question Text</label>
                    <input id="question-text" type="text" placeholder="Enter your question" required />
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="question-type">Type</label>
                        <select id="question-type">
                            <option value="slider">Slider (1-10)</option>
                            <option value="hours-slider">Hours per day (1-24)</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="yes-no">Yes / No</option>
                            <option value="text">Open Text</option>
                        </select>
                    </div>
                    <div class="form-col"></div>
                </div>
                <div id="type-specific-options"></div>
                <button type="submit" class="btn btn-primary">Add Question</button>
            </form>
            <h3 style="margin-top:1rem;">Question List</h3>
            <div id="questions-list"></div>
        </section>

        <div id="analytics-panel" class="admin-panel" style="display: block;">
            <!-- Quarterly Reminder Banner -->
            <div id="quarterly-reminder" class="quarterly-banner" style="display: none;">
                <div class="banner-content">
                    <span class="banner-icon">üìÖ</span>
                    <div class="banner-text">
                        <strong id="banner-title">Q4 2025 ends December 31</strong>
                        <span id="banner-message">Export your quarterly report now!</span>
                    </div>
                </div>
                <div class="banner-actions">
                    <button id="auto-export-quarter" class="btn btn-primary">üì• Export Quarter</button>
                    <button id="dismiss-reminder" class="btn btn-ghost">Dismiss</button>
                </div>
            </div>

            <h2>Dashboard Overview</h2>

            <!-- Modern KPI Cards -->
            <section class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-icon">üìä</span>
                        <span class="kpi-label">Total Responses</span>
                    </div>
                    <div class="kpi-value" id="total-responses">0</div>
                    <div class="kpi-trend" id="responses-trend">
                        <span class="trend-indicator">‚Äî</span>
                        <span class="trend-text">vs. previous period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-icon">üéØ</span>
                        <span class="kpi-label">Conversion Rate</span>
                    </div>
                    <div class="kpi-value" id="conversion-rate">0%</div>
                    <div class="kpi-trend" id="conversion-trend">
                        <span class="trend-indicator">‚Äî</span>
                        <span class="trend-text">vs. previous period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-icon">üìà</span>
                        <span class="kpi-label">Average Score</span>
                    </div>
                    <div class="kpi-value" id="average-score">0</div>
                    <div class="kpi-trend" id="score-trend">
                        <span class="trend-indicator">‚Äî</span>
                        <span class="trend-text">vs. previous period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-icon">‚úâÔ∏è</span>
                        <span class="kpi-label">Email Leads</span>
                    </div>
                    <div class="kpi-value" id="total-leads">0</div>
                    <div class="kpi-trend" id="leads-trend">
                        <span class="trend-indicator">‚Äî</span>
                        <span class="trend-text">vs. previous period</span>
                    </div>
                </div>
            </section>

            <!-- Quick Insights -->
            <section class="quick-insights">
                <div class="insight-card">
                    <div class="insight-icon">üìà</div>
                    <div class="insight-content">
                        <div class="insight-label">Top Campaign</div>
                        <div class="insight-value" id="top-campaign">Loading...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">üéØ</div>
                    <div class="insight-content">
                        <div class="insight-label">Best Traffic Source</div>
                        <div class="insight-value" id="top-source">Loading...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">‚è±Ô∏è</div>
                    <div class="insight-content">
                        <div class="insight-label">Avg. Completion Time</div>
                        <div class="insight-value" id="avg-time">Loading...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">üìä</div>
                    <div class="insight-content">
                        <div class="insight-label">High Need Users</div>
                        <div class="insight-value" id="high-need-count">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <section class="filters-section" style="margin: 0.5rem 0 1.25rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Filters</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="export-csv" class="btn btn-secondary" type="button">üì• Export CSV</button>
                        <button id="export-pdf" class="btn btn-secondary" type="button">üìÑ Export PDF</button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="filter-from">From date</label>
                        <input type="date" id="filter-from" />
                    </div>
                    <div class="form-col">
                        <label for="filter-to">To date</label>
                        <input type="date" id="filter-to" />
                    </div>
                    <div class="form-col">
                        <label for="filter-min-score">Min score</label>
                        <input type="number" id="filter-min-score" min="0" max="100" placeholder="0" />
                    </div>
                    <div class="form-col">
                        <label for="filter-max-score">Max score</label>
                        <input type="number" id="filter-max-score" min="0" max="100" placeholder="100" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="filter-source">UTM Source</label>
                        <select id="filter-source"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-medium">UTM Medium</label>
                        <select id="filter-medium"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-campaign">UTM Campaign</label>
                        <select id="filter-campaign"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-reco">Recommendation</label>
                        <select id="filter-reco">
                            <option value="">All</option>
                            <option value="high-need">High Need</option>
                            <option value="moderate-need">Moderate Need</option>
                            <option value="low-need">Low Need</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col" style="display:flex; gap:.5rem; align-items:center;">
                        <button id="preset-7d" class="btn btn-secondary" type="button">Last 7 days</button>
                        <button id="preset-30d" class="btn btn-secondary" type="button">Last 30 days</button>
                        <button id="preset-all" class="btn btn-secondary" type="button">All time</button>
                        <span style="flex:1"></span>
                    </div>
                </div>
            </section>

            <!-- Charts -->
            <section class="charts-section">
                <div class="chart-container"><canvas id="response-chart"></canvas></div>
                <div class="chart-container"><canvas id="hearing-issues-chart"></canvas></div>
                <div class="chart-container"><canvas id="score-histogram"></canvas></div>
                <div class="chart-container"><canvas id="utm-score-chart"></canvas></div>
                <div class="chart-container"><canvas id="question-averages-chart"></canvas></div>
                <div class="chart-container"><canvas id="utm-campaign-score-chart"></canvas></div>
            </section>

            <!-- Housekeeping -->
            <section class="export-section">
                <h3>Data Management</h3>
                <div class="form-row">
                    <div class="form-col" style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
                        <button id="clear-data" class="btn btn-danger" type="button">üóëÔ∏è Clear All Data</button>
                        <span style="flex:1"></span>
                        <label style="color: var(--sb-muted); font-size: 0.875rem; margin-right: 0.5rem;">Lead notification email:</label>
                        <input type="email" id="company-email" placeholder="your@email.com" style="max-width:320px;" />
                    </div>
                </div>
            </section>

            <!-- Optional: Results Box Customization (saved to quiz-settings) -->
            <section>
                <h3>Results Box Customization</h3>
                <p class="sb-copy" style="margin:.25rem 0 .6rem;opacity:.9">Optional: Override the final results box text and accent color.</p>
                <form id="quiz-settings">
                    <div class="form-group">
                        <label for="result-title">Result Title</label>
                        <input type="text" id="result-title" placeholder="e.g., Soundbites Highly Recommended" />
                    </div>
                    <div class="form-group">
                        <label for="result-message">Result Message</label>
                        <textarea id="result-message" placeholder="Short explanation shown under the title"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="result-cta">CTA Text</label>
                            <input type="text" id="result-cta" placeholder="e.g., Visit soundbites.com" />
                        </div>
                        <div class="form-col">
                            <label for="result-cta-url">CTA URL</label>
                            <input type="url" id="result-cta-url" placeholder="https://soundbites.com" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="result-color">Accent Color</label>
                        <input type="color" id="result-color" value="#C92A76" style="width:60px;height:36px;padding:0;border:1px solid #ddd;border-radius:6px;" />
                    </div>
                    <button type="submit" class="btn btn-primary">Save Quiz Settings</button>
                </form>
            </section>

            <hr style="margin:1.25rem 0; border:none; border-top:1px solid #e0e0e0;" />
            <section>
                <h3>Account Recovery</h3>
                <p class="sb-copy" style="margin:.25rem 0 .6rem;opacity:.9">Generate a one-time recovery code to reset your username and password if you forget them. Save it somewhere safe.</p>
                <button id="generate-recovery" type="button" class="btn btn-secondary">Generate New Recovery Code</button>
            </section>
        </div>

        <!-- Marketing Panel -->
        <div id="marketing-panel" class="admin-panel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">üìä Marketing Analytics</h2>
                <span class="section-badge">Campaign Performance & ROI</span>
            </div>

            <!-- Campaign Performance Table -->
            <div class="analytics-card">
                <h3>Campaign Performance</h3>
                <div class="table-container">
                    <table id="campaign-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Campaign</th>
                                <th>Visits</th>
                                <th>Leads</th>
                                <th>Conv. Rate</th>
                                <th>Avg Score</th>
                                <th>High Need %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" style="text-align: center; color: #999;">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Traffic Source & Conversion Funnel -->
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Traffic Sources</h3>
                    <div class="chart-container"><canvas id="traffic-source-chart"></canvas></div>
                </div>
                <div class="analytics-card">
                    <h3>Conversion Funnel</h3>
                    <div class="chart-container"><canvas id="conversion-funnel-chart"></canvas></div>
                </div>
            </div>

            <!-- Time-Based Analysis -->
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Conversions by Day of Week</h3>
                    <div class="chart-container"><canvas id="day-of-week-chart"></canvas></div>
                </div>
                <div class="analytics-card">
                    <h3>Conversions by Hour</h3>
                    <div class="chart-container"><canvas id="hour-of-day-chart"></canvas></div>
                </div>
            </div>

            <!-- UTM Source/Medium Performance -->
            <div class="analytics-card">
                <h3>Source/Medium Performance</h3>
                <div class="chart-container"><canvas id="source-medium-chart"></canvas></div>
            </div>
        </div>

        <!-- OTIS Clinical Trial Panel -->
        <div id="otis-panel" class="admin-panel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">üî¨ OTIS Clinical Trial Data</h2>
                <span class="section-badge" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">Research Analytics</span>
            </div>

            <!-- Trial Summary Stats -->
            <div class="trial-summary-grid">
                <div class="trial-stat-card">
                    <div class="trial-stat-icon">üë•</div>
                    <div class="trial-stat-content">
                        <div class="trial-stat-label">Total Participants</div>
                        <div class="trial-stat-value" id="trial-participants">0</div>
                    </div>
                </div>
                <div class="trial-stat-card">
                    <div class="trial-stat-icon">üìä</div>
                    <div class="trial-stat-content">
                        <div class="trial-stat-label">Mean Score</div>
                        <div class="trial-stat-value" id="trial-mean-score">0</div>
                        <div class="trial-stat-detail" id="trial-std-dev">SD: 0</div>
                    </div>
                </div>
                <div class="trial-stat-card">
                    <div class="trial-stat-icon">üéØ</div>
                    <div class="trial-stat-content">
                        <div class="trial-stat-label">High Need Cases</div>
                        <div class="trial-stat-value" id="trial-high-need">0</div>
                        <div class="trial-stat-detail" id="trial-high-need-pct">0%</div>
                    </div>
                </div>
                <div class="trial-stat-card">
                    <div class="trial-stat-icon">üìà</div>
                    <div class="trial-stat-content">
                        <div class="trial-stat-label">95% CI</div>
                        <div class="trial-stat-value" id="trial-confidence">‚Äî</div>
                    </div>
                </div>
            </div>

            <!-- Demographics Analysis -->
            <div class="analytics-card">
                <h3>üìã Participant Demographics</h3>
                <div class="table-container">
                    <table id="demographics-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Age Range</th>
                                <th>N</th>
                                <th>Mean Score</th>
                                <th>SD</th>
                                <th>High Need %</th>
                                <th>Conversion %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" style="text-align: center; color: #999;">Calculating demographics...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Score Distribution & Statistical Analysis -->
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Score Distribution (Histogram)</h3>
                    <div class="chart-container"><canvas id="trial-score-dist"></canvas></div>
                </div>
                <div class="analytics-card">
                    <h3>Recommendation Breakdown</h3>
                    <div class="chart-container"><canvas id="trial-recommendation-chart"></canvas></div>
                </div>
            </div>

            <!-- Question-Level Analysis -->
            <div class="analytics-card">
                <h3>üìä Question Performance Analysis</h3>
                <div class="table-container">
                    <table id="question-analysis-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Mean Response</th>
                                <th>SD</th>
                                <th>Median</th>
                                <th>Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align: center; color: #999;">Analyzing questions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Correlation Matrix -->
            <div class="analytics-card">
                <h3>üîó Correlations (Score vs. Questions)</h3>
                <div class="chart-container"><canvas id="correlation-chart"></canvas></div>
            </div>

            <!-- Export Options for Clinical Trial -->
            <div class="analytics-card">
                <h3>üì§ Export Trial Data</h3>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button id="export-trial-csv" class="btn btn-primary">üìä Export Raw Data (CSV)</button>
                    <button id="export-trial-report" class="btn btn-primary">üìÑ Generate Statistical Report (PDF)</button>
                    <button id="export-spss" class="btn btn-secondary">üíæ Export for SPSS</button>
                    <button id="export-r" class="btn btn-secondary">üìà Export for R</button>
                </div>
                <p style="margin-top: 1rem; color: var(--sb-muted); font-size: 0.875rem;">
                    Data exports are formatted for clinical trial submission and statistical analysis software.
                </p>
            </div>
        </div>

        </main>
    </div>

    <script src="/app/api-client.js"></script>
    <script src="/admin/admin.js?v=20251020-1740"></script>
    <script>
        // Invoke auth gate after DOM is ready so login view replaces body safely when not authed
        document.addEventListener('DOMContentLoaded', function(){
            if (window.initHeaderSizer) window.initHeaderSizer();
            if (window.enforceAuth && !window.enforceAuth()) return;
            if (window.sbIsAuthed && window.sbIsAuthed()) {
                if (!window.admin && typeof QuizAdmin === 'function') { window.admin = new QuizAdmin(); }
                // Attach logout handler
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn && window.sbAdminLogout) {
                    logoutBtn.onclick = window.sbAdminLogout;
                }
            }
        }, { once: true });
    </script>
  </body>
</html>