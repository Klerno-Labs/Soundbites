<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Soundbites Admin</title>
    <meta name="description" content="Admin panel for managing the Soundbites hearing quiz and viewing analytics">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='16' fill='%23C92A76'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/admin/admin.css?v=20251020-1740">
    <script src="/app/config.js"></script>
    <script src="/app/header-sizer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/admin/admin-auth-backend.js"></script>
</head>
<body>
    <a href="#main" class="skip-link">Skip to content</a>
    <div class="container" role="application">
        <header>
            <div class="logo-container">
                <img src="/app/soundbites_logo_magenta.webp" alt="Soundbites Logo" class="brand-logo" />
                <span class="play-button-accent" aria-hidden="true"></span>
            </div>
            <p class="sb-copy">Discover if Soundbites can improve your hearing experience</p>
            <div class="wave-decoration">
                <img src="/app/dot_wave_2.webp" alt="Sound Wave" class="wave-graphic">
            </div>
            <nav class="admin-nav">
                <button id="questions-tab" class="tab-btn" type="button" onclick="console.log('Questions clicked'); if(window.admin){window.admin.switchTab('questions')}else{console.error('window.admin not found')}">Questions</button>
                <button id="analytics-tab" class="tab-btn active" type="button" onclick="console.log('Analytics clicked'); if(window.admin){window.admin.switchTab('analytics')}else{console.error('window.admin not found')}">Analytics</button>
                <button id="marketing-tab" class="tab-btn" type="button" onclick="console.log('Marketing clicked'); if(window.admin){window.admin.switchTab('marketing')}else{console.error('window.admin not found')}">Marketing</button>
                <button id="users-tab" class="tab-btn" type="button" onclick="console.log('Users clicked'); if(window.admin){window.admin.switchTab('users')}else{console.error('window.admin not found')}">Users</button>
                <span style="flex:1"></span>
                <button id="logout-btn" class="btn btn-sm btn-danger" type="button">Log out</button>
            </nav>
        </header>

        <main id="main" role="main">
        <!-- Questions Panel (top-level sibling of Analytics) -->
        <section id="questions-panel" class="admin-panel" style="display:none;">
            <h2>Manage Questions</h2>
            <form id="question-form">
                <div class="form-group">
                    <label for="question-text">Question Text</label>
                    <input id="question-text" type="text" placeholder="Enter your question" required />
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="question-type">Type</label>
                        <select id="question-type">
                            <option value="slider">Slider (1-10)</option>
                            <option value="hours-slider">Hours per day (1-24)</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="yes-no">Yes / No</option>
                            <option value="text">Open Text</option>
                        </select>
                    </div>
                    <div class="form-col"></div>
                </div>
                <div id="type-specific-options"></div>
                <button type="submit" class="btn btn-primary">Add Question</button>
            </form>
            <h3 style="margin-top:1rem;">Question List</h3>
            <div id="questions-list"></div>
        </section>

        <div id="analytics-panel" class="admin-panel" style="display: block;">
            <!-- Quarterly Reminder Banner -->
            <div id="quarterly-reminder" class="quarterly-banner" style="display: none;">
                <div class="banner-content">
                    <span class="banner-icon">üìÖ</span>
                    <div class="banner-text">
                        <strong id="banner-title">Q4 2025 ends December 31</strong>
                        <span id="banner-message">Export your quarterly report now!</span>
                    </div>
                </div>
                <div class="banner-actions">
                    <button id="auto-export-quarter" class="btn btn-primary">üì• Export Quarter</button>
                    <button id="dismiss-reminder" class="btn btn-ghost">Dismiss</button>
                </div>
            </div>

            <h2>Dashboard Overview</h2>

            <!-- Modern KPI Cards -->
            <section class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-icon">üìä</span>
                        <span class="kpi-label">Total Responses</span>
                    </div>
                    <div class="kpi-value" id="total-responses">0</div>
                    <div class="kpi-trend" id="responses-trend">
                        <span class="trend-indicator">‚Äî</span>
                        <span class="trend-text">vs. previous period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-icon">üéØ</span>
                        <span class="kpi-label">Conversion Rate</span>
                    </div>
                    <div class="kpi-value" id="conversion-rate">0%</div>
                    <div class="kpi-trend" id="conversion-trend">
                        <span class="trend-indicator">‚Äî</span>
                        <span class="trend-text">vs. previous period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-icon">üìà</span>
                        <span class="kpi-label">Average Score</span>
                    </div>
                    <div class="kpi-value" id="average-score">0</div>
                    <div class="kpi-trend" id="score-trend">
                        <span class="trend-indicator">‚Äî</span>
                        <span class="trend-text">vs. previous period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-icon">‚úâÔ∏è</span>
                        <span class="kpi-label">Email Leads</span>
                    </div>
                    <div class="kpi-value" id="total-leads">0</div>
                    <div class="kpi-trend" id="leads-trend">
                        <span class="trend-indicator">‚Äî</span>
                        <span class="trend-text">vs. previous period</span>
                    </div>
                </div>
            </section>

            <!-- Quick Insights -->
            <section class="quick-insights">
                <div class="insight-card">
                    <div class="insight-icon">üìà</div>
                    <div class="insight-content">
                        <div class="insight-label">Top Campaign</div>
                        <div class="insight-value" id="top-campaign">Loading...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">üéØ</div>
                    <div class="insight-content">
                        <div class="insight-label">Best Traffic Source</div>
                        <div class="insight-value" id="top-source">Loading...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">‚è±Ô∏è</div>
                    <div class="insight-content">
                        <div class="insight-label">Avg. Completion Time</div>
                        <div class="insight-value" id="avg-time">Loading...</div>
                    </div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">üìä</div>
                    <div class="insight-content">
                        <div class="insight-label">High Need Users</div>
                        <div class="insight-value" id="high-need-count">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <section class="filters-section" style="margin: 0.5rem 0 1.25rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Filters</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="export-csv" class="btn btn-secondary" type="button">üì• Export CSV</button>
                        <button id="export-pdf" class="btn btn-secondary" type="button">üìÑ Export PDF</button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="filter-from">From date</label>
                        <input type="date" id="filter-from" />
                    </div>
                    <div class="form-col">
                        <label for="filter-to">To date</label>
                        <input type="date" id="filter-to" />
                    </div>
                    <div class="form-col">
                        <label for="filter-min-score">Min score</label>
                        <input type="number" id="filter-min-score" min="0" max="100" placeholder="0" />
                    </div>
                    <div class="form-col">
                        <label for="filter-max-score">Max score</label>
                        <input type="number" id="filter-max-score" min="0" max="100" placeholder="100" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="filter-source">UTM Source</label>
                        <select id="filter-source"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-medium">UTM Medium</label>
                        <select id="filter-medium"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-campaign">UTM Campaign</label>
                        <select id="filter-campaign"><option value="">All</option></select>
                    </div>
                    <div class="form-col">
                        <label for="filter-reco">Recommendation</label>
                        <select id="filter-reco">
                            <option value="">All</option>
                            <option value="high-need">High Need</option>
                            <option value="moderate-need">Moderate Need</option>
                            <option value="low-need">Low Need</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col" style="display:flex; gap:.5rem; align-items:center;">
                        <button id="preset-7d" class="btn btn-secondary" type="button">Last 7 days</button>
                        <button id="preset-30d" class="btn btn-secondary" type="button">Last 30 days</button>
                        <button id="preset-all" class="btn btn-secondary" type="button">All time</button>
                        <span style="flex:1"></span>
                    </div>
                </div>
            </section>

            <!-- Charts -->
            <section class="charts-section">
                <div class="chart-container"><canvas id="response-chart"></canvas></div>
                <div class="chart-container"><canvas id="hearing-issues-chart"></canvas></div>
                <div class="chart-container"><canvas id="score-histogram"></canvas></div>
                <div class="chart-container"><canvas id="utm-score-chart"></canvas></div>
                <div class="chart-container"><canvas id="question-averages-chart"></canvas></div>
                <div class="chart-container"><canvas id="utm-campaign-score-chart"></canvas></div>
            </section>

            <!-- Housekeeping -->
            <section class="export-section">
                <h3>Data Management</h3>
                <div class="form-row">
                    <div class="form-col" style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
                        <button id="clear-data" class="btn btn-danger" type="button">üóëÔ∏è Clear All Data</button>
                        <span style="flex:1"></span>
                        <label style="color: var(--sb-muted); font-size: 0.875rem; margin-right: 0.5rem;">Lead notification email:</label>
                        <input type="email" id="company-email" placeholder="your@email.com" style="max-width:320px;" />
                    </div>
                </div>
            </section>

            <!-- Optional: Results Box Customization (saved to quiz-settings) -->
            <section>
                <h3>Results Box Customization</h3>
                <p class="sb-copy" style="margin:.25rem 0 .6rem;opacity:.9">Optional: Override the final results box text and accent color.</p>
                <form id="quiz-settings">
                    <div class="form-group">
                        <label for="result-title">Result Title</label>
                        <input type="text" id="result-title" placeholder="e.g., Soundbites Highly Recommended" />
                    </div>
                    <div class="form-group">
                        <label for="result-message">Result Message</label>
                        <textarea id="result-message" placeholder="Short explanation shown under the title"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="result-cta">CTA Text</label>
                            <input type="text" id="result-cta" placeholder="e.g., Visit soundbites.com" />
                        </div>
                        <div class="form-col">
                            <label for="result-cta-url">CTA URL</label>
                            <input type="url" id="result-cta-url" placeholder="https://soundbites.com" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="result-color">Accent Color</label>
                        <input type="color" id="result-color" value="#C92A76" style="width:60px;height:36px;padding:0;border:1px solid #ddd;border-radius:6px;" />
                    </div>
                    <button type="submit" class="btn btn-primary">Save Quiz Settings</button>
                </form>
            </section>

            <hr style="margin:1.25rem 0; border:none; border-top:1px solid #e0e0e0;" />
            <section>
                <h3>Account Recovery</h3>
                <p class="sb-copy" style="margin:.25rem 0 .6rem;opacity:.9">Generate a one-time recovery code to reset your username and password if you forget them. Save it somewhere safe.</p>
                <button id="generate-recovery" type="button" class="btn btn-secondary">Generate New Recovery Code</button>
            </section>
        </div>

        <!-- Marketing Panel -->
        <div id="marketing-panel" class="admin-panel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">üìä Marketing Analytics</h2>
                <span class="section-badge">Campaign Performance & ROI</span>
            </div>

            <!-- Campaign Performance Table -->
            <div class="analytics-card">
                <h3>Campaign Performance</h3>
                <div class="table-container">
                    <table id="campaign-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Campaign</th>
                                <th>Visits</th>
                                <th>Leads</th>
                                <th>Conv. Rate</th>
                                <th>Avg Score</th>
                                <th>High Need %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" style="text-align: center; color: #999;">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Traffic Source & Conversion Funnel -->
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Traffic Sources</h3>
                    <div class="chart-container"><canvas id="traffic-source-chart"></canvas></div>
                </div>
                <div class="analytics-card">
                    <h3>Conversion Funnel</h3>
                    <div class="chart-container"><canvas id="conversion-funnel-chart"></canvas></div>
                </div>
            </div>

            <!-- Time-Based Analysis -->
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Conversions by Day of Week</h3>
                    <div class="chart-container"><canvas id="day-of-week-chart"></canvas></div>
                </div>
                <div class="analytics-card">
                    <h3>Conversions by Hour</h3>
                    <div class="chart-container"><canvas id="hour-of-day-chart"></canvas></div>
                </div>
            </div>

            <!-- UTM Source/Medium Performance -->
            <div class="analytics-card">
                <h3>Source/Medium Performance</h3>
                <div class="chart-container"><canvas id="source-medium-chart"></canvas></div>
            </div>
        </div>

        <!-- Users Panel -->
        <div id="users-panel" class="admin-panel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">üë• User Management</h2>
                <button id="add-user-btn" class="btn btn-primary">+ Add User</button>
            </div>

            <!-- User List Table -->
            <div class="analytics-card">
                <h3>Admin Users</h3>
                <div class="table-container">
                    <table id="users-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align: center; color: #999;">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Role Descriptions -->
            <div class="analytics-card" style="margin-top: 1.5rem;">
                <h3>Role Descriptions</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #c92a76;">
                        <strong style="color: #c92a76;">Admin</strong>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Full access to all features including user management</p>
                    </div>
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d;">
                        <strong style="color: #6c757d;">Editor</strong>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Can edit questions and view analytics</p>
                    </div>
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <strong style="color: #17a2b8;">Viewer</strong>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Read-only access to analytics</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit User Modal -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="user-modal-title">Add User</h3>
                    <button id="close-user-modal" class="modal-close">&times;</button>
                </div>
                <form id="user-form">
                    <input type="hidden" id="user-id" />
                    <div class="form-group">
                        <label for="user-username">Username</label>
                        <input type="text" id="user-username" required minlength="3" maxlength="50" />
                    </div>
                    <div class="form-group">
                        <label for="user-email">Email</label>
                        <input type="email" id="user-email" required />
                    </div>
                    <div class="form-group">
                        <label for="user-password">Password</label>
                        <input type="password" id="user-password" minlength="8" />
                        <small id="password-hint" style="color: #666; font-size: 0.85rem;">Leave blank to keep existing password</small>
                    </div>
                    <div class="form-group">
                        <label for="user-role">Role</label>
                        <select id="user-role" required>
                            <option value="viewer">Viewer</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancel-user-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save User</button>
                    </div>
                </form>
            </div>
        </div>

        </main>
    </div>

    <script src="/app/api-client.js"></script>
    <script src="/admin/admin.js?v=20251020-1740"></script>
    <script src="/admin/admin-users.js"></script>
    <script>
        // Invoke auth gate after DOM is ready so login view replaces body safely when not authed
        document.addEventListener('DOMContentLoaded', async function(){
            if (window.initHeaderSizer) window.initHeaderSizer();

            // Properly await the async enforceAuth function
            const isAuthed = await window.enforceAuth();
            if (!isAuthed) return;

            // Initialize admin panel
            if (!window.admin && typeof QuizAdmin === 'function') {
                window.admin = new QuizAdmin();
            }

            // Attach logout handler
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn && window.sbAdminLogout) {
                logoutBtn.onclick = window.sbAdminLogout;
            }
        }, { once: true });
    </script>
  </body>
</html>